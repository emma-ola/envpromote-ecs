name: Reusable - Deploy to ECS

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      digest:
        required: true
        type: string
      taskdef_path:
        required: true
        type: string
    secrets:
      AWS_ROLE_ARN:
        required: true
      AWS_REGION:
        required: true
      ECR_REPOSITORY_URL:
        required: true
      ECS_TASK_EXECUTION_ROLE_ARN:
        required: true
      ECS_CLUSTER:
        required: true
      ECS_SERVICE:
        required: true
      CONTAINER_NAME:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Validate task definition matches environment
        run: |
          set -euo pipefail

          FAMILY=$(jq -r '.family' "${{ inputs.taskdef_path }}")

          if [[ "$FAMILY" != *"${{ inputs.environment }}"* ]]; then
            echo "❌ Task definition family '$FAMILY' does not match environment '${{ inputs.environment }}'"
            exit 1
          fi

          echo "✅ Task definition family '$FAMILY' matches environment '${{ inputs.environment }}'"

      - name: Inject execution role into task definition template
        run: |
          sed -i.bak "s|EXEC_ROLE_ARN_PLACEHOLDER|${{ secrets.ECS_TASK_EXECUTION_ROLE_ARN }}|g" ${{ inputs.taskdef_path }}
          rm -f ${{ inputs.taskdef_path }}.bak

      - name: Compute immutable image URI
        id: image
        run: |
          echo "image_uri=${{ secrets.ECR_REPOSITORY_URL }}@${{ inputs.digest }}" >> "$GITHUB_OUTPUT"

      - name: Render task definition with digest image
        id: render
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ inputs.taskdef_path }}
          container-name: ${{ secrets.CONTAINER_NAME }}
          image: ${{ steps.image.outputs.image_uri }}

      - name: Deploy to ECS service
        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
        with:
          task-definition: ${{ steps.render.outputs.task-definition }}
          service: ${{ secrets.ECS_SERVICE }}
          cluster: ${{ secrets.ECS_CLUSTER }}
          wait-for-service-stability: true

      - name: Verify service is running the promoted digest
        run: |
          set -euo pipefail

          CLUSTER="${{ secrets.ECS_CLUSTER }}"
          SERVICE="${{ secrets.ECS_SERVICE }}"
          EXPECTED_DIGEST="${{ inputs.digest }}"

          TASK_ARN=$(aws ecs list-tasks \
            --cluster "$CLUSTER" \
            --service-name "$SERVICE" \
            --desired-status RUNNING \
            --query 'taskArns[0]' \
            --output text)

          if [ -z "$TASK_ARN" ] || [ "$TASK_ARN" = "None" ]; then
            echo "No running tasks found for service $SERVICE"
            exit 1
          fi

          RUNNING_DIGEST=$(aws ecs describe-tasks \
            --cluster "$CLUSTER" \
            --tasks "$TASK_ARN" \
            --query 'tasks[0].containers[0].imageDigest' \
            --output text)

          echo "Expected: $EXPECTED_DIGEST"
          echo "Running:  $RUNNING_DIGEST"

          if [ "$RUNNING_DIGEST" != "$EXPECTED_DIGEST" ]; then
            echo "❌ Service is NOT running the promoted digest. Likely auto-rollback occurred."
            exit 1
          fi

          echo "✅ Service is running the promoted digest."

      - name: Summary
        run: |
          echo "### ✅ Deployed to ECS (${{ inputs.environment }})" >> $GITHUB_STEP_SUMMARY
          echo "- Image (immutable): \`${{ steps.image.outputs.image_uri }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Write promotion record
        if: always()
        id: record
        run: |
          set -euo pipefail
          TS="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          STATUS="${{ job.status }}"
          ENV="${{ inputs.environment }}"
          DIGEST="${{ inputs.digest }}"
          IMAGE_URI="${{ secrets.ECR_REPOSITORY_URL }}@${{ inputs.digest }}"

          mkdir -p promotion-history

          cat > "promotion-history/${ENV}-${{ github.run_id }}-${{ github.run_attempt }}.json" <<EOF
          {
            "timestamp_utc": "${TS}",
            "environment": "${ENV}",
            "digest": "${DIGEST}",
            "image_uri": "${IMAGE_URI}",
            "status": "${STATUS}",
            "actor": "${{ github.actor }}",
            "repo": "${{ github.repository }}",
            "workflow": "${{ github.workflow }}",
            "run_id": ${{ github.run_id }},
            "run_attempt": ${{ github.run_attempt }},
            "ref": "${{ github.ref }}",
            "sha": "${{ github.sha }}"
          }
          EOF

      - name: Upload promotion history artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: promotion-history-${{ inputs.environment }}-${{ github.run_id }}
          path: promotion-history/*.json
          retention-days: 30
