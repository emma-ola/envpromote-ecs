name: Build & Push Image to ECR (dev)

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: dev

    permissions:
      id-token: write
      contents: read

    outputs:
      image: ${{ steps.meta.outputs.image }}
      digest: ${{ steps.digest.outputs.digest }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compute image tags
        id: meta
        run: |
          echo "image=${{ secrets.ECR_REPOSITORY_URL }}" >> "$GITHUB_OUTPUT"
          echo "sha_tag=${{ github.sha }}" >> "$GITHUB_OUTPUT"

      - name: Build & push (with cache)
        id: build-push
        uses: docker/build-push-action@v6
        with:
          context: ./app
          push: true
          tags: |
            ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.sha_tag }}
            ${{ steps.meta.outputs.image }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # docker/build-push-action exposes the digest as an output
      - name: Capture digest
        id: digest
        run: |
          echo "digest=${{ steps.build-push.outputs.digest }}" >> "$GITHUB_OUTPUT"

      - name: Job summary
        run: |
          echo "### âœ… Built & pushed to ECR (dev)" >> $GITHUB_STEP_SUMMARY
          echo "- Image: \`${{ steps.meta.outputs.image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Tags: \`${{ github.sha }}\`, \`latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- Digest: \`${{ steps.build-push.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
